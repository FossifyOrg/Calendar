name: Generate holiday ICS files

on:
  schedule:
    # Run every year on 1st December, midnight
    - cron: "0 0 1 12 *"
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - ".github/workflows/holiday-generator/package-lock.json"
      - ".github/workflows/holiday-generator/config.js"

jobs:
  generate:
    name: Generate ICS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: Install NodeJS
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 20
      - name: Run script
        env:
          LOG_ENABLED: true
        working-directory: ./.github/workflows/holiday-generator
        run: "npm install && npm start"

      - name: Install keep-a-changelog parser
        run: npm install keep-a-changelog@2.6.2

      - name: Update changelog
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { parser } = require('keep-a-changelog');
            const changelogPath = path.join(process.env.GITHUB_WORKSPACE, 'CHANGELOG.md');

            const changelogContent = fs.readFileSync(changelogPath, 'utf8');
            const parsed = parser(changelogContent);

            const unreleased = parsed.findRelease();
            if (!unreleased) {
              throw new Error('No [Unreleased] section found in CHANGELOG.md');
            }

            const changedEntries = unreleased.changes.get('changed') || [];
            if (!changedEntries.some(entry => entry.toString().includes('Updated holiday data'))) {
              unreleased.changed('Updated holiday data');
              fs.writeFileSync(changelogPath, parsed.toString(), 'utf8');
              console.log('Added "Updated holiday data" to [Unreleased] section');
            } else {
              console.log('"Updated holiday data" already present in [Unreleased] section');
            }

      - name: Normalize changelog
        run: npx keep-a-changelog --file="CHANGELOG.md" --no-v-prefix

      - id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Create PR
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0
        with:
          token: ${{ steps.app-token.outputs.token }}
          sign-commits: true
          add-paths: |
            app/src/main/assets/holidays/**
            CHANGELOG.md
          branch: fossifybot/holidays
          commit-message: "chore: update holidays"
          title: "chore: update holidays"
          body: " "
